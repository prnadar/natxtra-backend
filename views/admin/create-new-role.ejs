<% 
  // Helper function to check permissions
  const hasPermission = (module, permissionType = 'manage') => {
    // Admins have all permissions
    if (typeof isAdmin !== 'undefined' && isAdmin) return true;
    // Check if user has the module and the specific permission
    return typeof userPermissions !== 'undefined' && userPermissions && userPermissions[module] && userPermissions[module][permissionType];
  };
%>
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EZ Door || Department</title>
  <%- include('partials/linkheader.ejs') %>
</head>

<body>
  <span id="pageId" style="display: none">user</span>
  <div class="page-wrapper">
    <!------Header END-------->

    <section class="listing-wrapper distributer-wrapper position-relative vh-100">
      <div class="container-fluid px-0 h-100">
        <div class="row mx-0 h-100">
          <div class="col-md-12 px-0">
            <div class="h-100">
              <%- include('partials/sidebar.ejs') %>
              <div class="right-side-block">
                <%- include('partials/header.ejs') %>

                <div class="card border-0 bg-transparent">
                  <div class="card-body p-0">
                    <div class="bg-white">
                      <div class="d-flex align-items-center justify-content-between p-4">
                        <h4 class="title-head">Department List</h4>
                        <% if (hasPermission('User', 'create')) { %>
                        <a href="" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newroleModal">Add New Department</a>
                        <% } %>
                      </div>
                      <div class="distributor-table bg-white p-4">
                        <div class="table-responsive">
                          <table class="table bg-white w-100">
                            <thead>
                              <tr>
                                <th>Department</th>
                                <th>Permissions</th>
                                <th>Actions</th>
                              </tr>
                            </thead>
                            <tbody class="text-center">
                              <% roles.forEach(role => { %>
                              <tr>
                                <td><%= role.name %></td>
                                <td>
                                  <% role.permissions.forEach(perm => { %>
                                  <div class="permission_label mb-1">
                                    <span><%= perm.module %></span>
                                    <% if (perm.permissions.manage) { %>
                                    <span class="badge bg-success">Manage</span>
                                    <% } %> <% if (perm.permissions.create) {
                                      %>
                                    <span class="badge bg-primary">Create</span>
                                    <% } %> <% if (perm.permissions.edit) { %>
                                    <span class="badge bg-warning text-dark">Edit</span>
                                    <% } %> <% if (perm.permissions.delete) {
                                      %>
                                    <span class="badge bg-danger">Delete</span>
                                    <% } %>
                                  </div>
                                  <% }) %>
                                </td>
                                <td>
                                  <% if (hasPermission('User', 'edit')) { %>
                                  <a href="#" class="btn btn-primary text-white edit-btn" data-model="<%= JSON.stringify(role) %>" data-bs-toggle="modal" data-bs-target="#editroleModal">Edit</a>
                                  <% } %>
                                  <% if (hasPermission('User', 'delete')) { %>
                                  <a href="#" class="delete-btn red-status text-black bg-transparent btn btn-default ms-2" data-id="<%=role._id%>">Delete</a>
                                  <% } %>
                                </td>
                              </tr>
                              <% }) %>
                            </tbody>
                          </table>
                        </div>
                         <div class="d-flex align-items-center justify-content-between">
  <p>
    Showing
    <%= Math.min(currentPage * pageSize, totalItems) %>
    of
    <%= totalItems %>
    entries
  </p>

  <nav aria-label="Page navigation">
    <ul class="pagination mb-0">

      <!-- Previous Button -->
      <li class="page-item <%= currentPage <= 1 ? 'disabled' : '' %>">
        <a class="page-link" href="?page=<%= currentPage - 1 %>">Previous</a>
      </li>

      <% 
        let startPage = Math.max(1, currentPage - 1);
        let endPage = Math.min(totalPages, startPage + 2);

        // Adjust startPage if we're near the end
        if (endPage - startPage < 2) {
          startPage = Math.max(1, endPage - 2);
        }
      %>

      <% for (let i = startPage; i <= endPage; i++) { %>
        <li class="page-item <%= i === currentPage ? 'active' : '' %>">
          <a class="page-link" href="?page=<%= i %>"><%= i %></a>
        </li>
      <% } %>

      <!-- Next Button -->
      <li class="page-item <%= currentPage >= totalPages ? 'disabled' : '' %>">
        <a class="page-link" href="?page=<%= currentPage + 1 %>">Next</a>
      </li>
    </ul>
  </nav>
</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!------listing-wrapper END-------->
  </div>
  <!------Page-wrapper END-------->
  <%- include('partials/linkfooter.ejs') %>

  <!-- Add role Modal -->
  <div class="modal fade" id="newroleModal" tabindex="-1" aria-labelledby="newroleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="newroleModalLabel">Create New Role</h3>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="createRoleForm">
            <div class="form-group">
              <label for="">Role</label>
              <input type="text" class="form-control" name="name" placeholder="Role" />
            </div>

            <div class="table-responsive mt-4">
              <table class="table">
                <thead>
                  <tr>
                    <th>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="flexCheckDefault" />
                        <label class="form-check-label" for="flexCheckDefault"></label>
                      </div>
                    </th>
                    <th>Module</th>
                    <th colspan="4">Permission</th>
                  </tr>
                </thead>
                <tbody>
                  <% const modules = [ "Dashboard", "Order", "Sales",
                    "Distributor", "User", "HR", "Inventory", "Accounts",
                    "Support Tickets", "Reports", "Setting", "Web Management" ];
                    %> <% modules.forEach(module => { %>
                  <tr>
                    <td><input type="checkbox" class="module-check" /></td>
                    <td><%= module %></td>
                    <td>
                      <input type="checkbox" class="perm" name="permissions" value='{"module":"<%= module %>","perm":"manage"}' />
                    </td>
                    <td>
                      <input type="checkbox" class="perm" name="permissions" value='{"module":"<%= module %>","perm":"create"}' />
                    </td>
                    <td>
                      <input type="checkbox" class="perm" name="permissions" value='{"module":"<%= module %>","perm":"edit"}' />
                    </td>
                    <td>
                      <input type="checkbox" class="perm" name="permissions" value='{"module":"<%= module %>","perm":"delete"}' />
                    </td>
                  </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary submit_btn">
            Save
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Role Modal -->
  <div class="modal fade" id="editroleModal" tabindex="-1" aria-labelledby="editroleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="editroleModalLabel">Edit Department</h3>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="edit-role-form">
            <input type="text" name="id" hidden id="edit_id" />
            <div class="form-group">
              <label for="">Role</label>
              <input type="text" class="form-control" name="name" placeholder="Role" />
            </div>

            <div class="table-responsive mt-4">
              <table class="table">
                <thead>
                  <tr>
                    <th>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="flexCheckDefault" />
                        <label class="form-check-label" for="flexCheckDefault"></label>
                      </div>
                    </th>
                    <th>Module</th>
                    <th colspan="4">Permission</th>
                  </tr>
                </thead>
                <tbody>
                  <% const modules2 = [ "Dashboard", "Order", "Sales",
                    "Distributor", "User", "HR", "Inventory", "Accounts",
                    "Support Tickets", "Reports", "Setting", "Web Management" ];
                    %> <% modules2.forEach(module => { %>
                  <tr>
                    <td><input type="checkbox" class="module-check" /></td>
                    <td><%= module %></td>
                    <% ["manage", "create", "edit", "delete"].forEach(perm =>
                      { %>
                    <td>
                      <input type="checkbox" class="perm" name="permissions" data-module="<%= module %>" data-perm="<%= perm %>" />
                    </td>
                    <% }) %>
                  </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary submit_btn2">
            Save
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    $(".submit_btn").on("click", function() {
      const name = $("input[name='name']").val();
      const modules = {};

      $(".perm:checked").each(function() {
        const data = JSON.parse($(this).val());
        const mod = data.module;
        const perm = data.perm;

        if (!modules[mod]) {
          modules[mod] = {
            module: mod,
            permissions: {
              manage: false,
              create: false,
              edit: false,
              delete: false,
            },
          };
        }

        modules[mod].permissions[perm] = true;
      });

      const payload = {
        name,
        modules: Object.values(modules),
      };

      $.ajax({
        url: "/admin/create-new-role",
        method: "POST",
        contentType: "application/json",
        data: JSON.stringify(payload),
        success: function(res) {
          renderToast({
            message: res.message,
            icon: "success"
          });
          setTimeout(() => {
            window.location.reload();
          }, 1000);
          $("#newroleModal").modal("hide");
        },
        error: function(err) {
          console.error(err);
          renderToast({
            message: "An error occurred while saving the role.",
            icon: "error",
          });
        },
      });
    });
  </script>

  <script>
    $(document).ready(function() {
      $(".submit_btn2").on("click", function() {
        const form = $("#edit-role-form");
        const name = form.find("input[name='name']").val();
        const id = form.find("#edit_id").val();

        const permissions = {};

        form.find("input[name='permissions']:checked").each(function() {
          const module = $(this).data("module");
          const perm = $(this).data("perm");

          if (!permissions[module]) {
            permissions[module] = {};
          }
          permissions[module][perm] = true;
        });

        const permissionArray = Object.entries(permissions).map(
          ([module, perms]) => ({
            module,
            permissions: perms,
          })
        );

        $.ajax({
          url: "/admin/update-role",
          type: "POST",
          data: {
            id,
            name,
            permissions: JSON.stringify(permissionArray), // OK
          },
          contentType: "application/x-www-form-urlencoded", // recommended
          success: function(res) {
            renderToast({
              message: res.message,
              icon: "success"
            });
            setTimeout(() => {
              location.reload();
            }, 1000);
          },
          error: function(err) {
            console.error(err);
            renderToast({
              message: "An error occurred while updating the role.",
              icon: "error",
            });
          },
        });
      });
    });
  </script>

  <script>
    $(".edit-btn").on("click", function() {
      const data = $(this).data("model");

      $("#editroleModal").modal("show");

      $("#editroleModal #edit_id").val(data._id);
      $("#editroleModal input[name='name']").val(data.name);

      // Reset all checkboxes
      $("#editroleModal input[name='permissions']").prop("checked", false);

      // Loop through permissions
      if (Array.isArray(data.permissions)) {
        data.permissions.forEach((permObj) => {
          const module = permObj.module;
          const perms = permObj.permissions;

          Object.entries(perms).forEach(([permKey, isAllowed]) => {
            if (isAllowed) {
              const selector = `#editroleModal input[data-module="${module}"][data-perm="${permKey}"]`;
              $(selector).prop("checked", true);
            }
          });
        });
      }
    });
  </script>

  <script>
    let selectedRoles = [];
    $(document).ready(function() {
      $(".form-check-input").on("change", function() {
        const value = $(this).val();
        if ($(this).is(":checked")) {
          if (!selectedRoles.includes(value)) {
            selectedRoles.push(value);
          }
        } else {
          // Remove value
          selectedRoles = selectedRoles.filter((item) => item !== value);
        }
        if (selectedRoles.length == 0) {
          $(".edit-btn").show();
        } else {
          $(".edit-btn").hide();
        }
      });

      $(".delete-btn").on("click", function(e) {
        const id = $(this).data("id");
        if (selectedRoles.length == 0) {
          if (confirm("Do you really want to delete this record")) {
            $.ajax({
              type: "POST",
              contentType: "application/json",
              url: "/admin/delete-role",
              data: JSON.stringify({
                id: id
              }),
              success: (res) => {
                renderToast({
                  message: res.message,
                  icon: "success"
                });
                setTimeout(() => {
                  window.location.reload();
                }, 1000);
              },
              error: (res) => {
                renderToast({
                  message: res.message,
                  icon: "error"
                });
                console.error(res);
              },
            });
          }
        } else {
          $.ajax({
            type: "POST",
            contentType: "application/json",
            url: "/admin/delete-roles",
            data: JSON.stringify(selectedRoles),
            success: (res) => {
              renderToast({
                message: res.message,
                icon: "success"
              });
              setTimeout(() => {
                window.location.reload();
              }, 1000);
            },
            error: (res) => {
              renderToast({
                message: res.message,
                icon: "error"
              });
              console.error(res);
            },
          });
        }
      });
    });
  </script>
</body>

</html>